<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout/layout :: layout (~{::body}, ~{::title})">

<body>
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4 th:text="${#strings.isEmpty(entry.id) ? 'Add New Sale' : 'Edit Sale'}">Sales Form</h4>
        </div>
        <div class="card-body">
            <form th:action="@{/sales/save}" th:object="${entry}" method="post" id="saleForm">
                <input type="hidden" th:field="*{id}" />
                <input type="hidden" id="originalBatchCode" th:value="*{batchCode}" />

                <div class="mb-3">
                    <label class="form-label">Product</label>
                    <select class="form-select" th:field="*{productId}" id="productSelect" required>
                        <option value="" disabled>Select a product</option>
                        <option th:each="p : ${products}" th:value="${p.id}" th:text="${p.name}"></option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Batch Code</label>
                    <select class="form-select" th:field="*{batchCode}" id="batchSelect" required>
                        <option value="" disabled>Select a batch</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Available Quantity</label>
                    <input type="text" id="availableQty" class="form-control" readonly />
                </div>

                <div class="mb-3">
                    <label class="form-label">Quantity Sold</label>
                    <input type="number" step="0.01" th:field="*{quantitySold}" id="quantitySold" class="form-control"
                        required />
                </div>

                <div class="mb-3">
                    <label class="form-label">Unit</label>
                    <input type="text" th:field="*{unit}" class="form-control" placeholder="kg, packets..." required />
                </div>

                <div class="mb-3">
                    <label class="form-label">Price per Unit (‚Çπ)</label>
                    <input type="number" step="0.01" th:field="*{pricePerUnit}" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label class="form-label">Sale Date</label>
                    <input type="date" class="form-control" th:value="${#temporals.format(entry.saleDate, 'yyyy-MM-dd')}" required />
                </div>

                <div class="mb-3">
                    <label class="form-label">Remarks</label>
                    <textarea th:field="*{remarks}" class="form-control" rows="2"></textarea>
                </div>

                <div class="d-flex justify-content-between">
                    <a th:href="@{/sales}" class="btn btn-secondary">‚Üê Back</a>
                    <button type="submit" class="btn btn-success">üíæ Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const productSelect = document.getElementById('productSelect');
            const batchSelect = document.getElementById('batchSelect');
            const availableQtyInput = document.getElementById('availableQty');
            const selectedBatchCode = document.getElementById('originalBatchCode')?.value || null;

            const selectedProductId = productSelect.value;
            if (selectedProductId) {
                loadBatches(selectedProductId, selectedBatchCode);
            }

            productSelect.addEventListener('change', function () {
                loadBatches(this.value, null);
            });

            batchSelect.addEventListener('change', function () {
                const qty = this.options[this.selectedIndex]?.getAttribute('data-qty');
                availableQtyInput.value = qty || '';
            });

            document.getElementById('saleForm').addEventListener('submit', function (e) {
                const available = parseFloat(availableQtyInput.value || 0);
                const selling = parseFloat(document.getElementById('quantitySold').value || 0);
                if (selling > available) {
                    e.preventDefault();
                    alert('Quantity sold exceeds available inventory!');
                }
            });

            function loadBatches(productId, selectedBatchCode = null) {
                batchSelect.innerHTML = '<option value="" disabled>Loading...</option>';
                availableQtyInput.value = '';

                fetch(`/api/inventory/batches?productId=${productId}`)
                    .then(res => res.json())
                    .then(data => {
                        batchSelect.innerHTML = '<option value="" disabled>Select a batch</option>';
                        data.forEach(batch => {
                            const option = document.createElement('option');
                            option.value = batch.batchCode;
                            option.textContent = batch.batchCode;
                            option.setAttribute('data-qty', batch.availableQuantity);
                            if (batch.batchCode === selectedBatchCode) {
                                option.selected = true;
                                availableQtyInput.value = batch.availableQuantity;
                            }
                            batchSelect.appendChild(option);
                        });

                        batchSelect.dispatchEvent(new Event('change'));
                    });
            }
        });
    </script>
</body>

</html>
